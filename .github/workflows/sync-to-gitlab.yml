name: Sync to GitLab

# Works with gitlab.com, self-hosted GitLab, or any GitLab instance
# Set GITLAB_REPO_URL secret to your GitLab repo URL

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper sync
          
      - name: Prevent sync loops
        run: |
          if git log -1 --pretty=%B | grep -q "\[skip sync\]"; then
            echo "Skipping sync - commit marked with [skip sync]"
            exit 0
          fi
          
      - name: Setup Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
      - name: Add GitLab remote
        run: |
          GITLAB_REPO_URL="${{ secrets.GITLAB_REPO_URL }}"
          if [ -z "$GITLAB_REPO_URL" ]; then
            echo "Error: GITLAB_REPO_URL secret is not set"
            exit 1
          fi
          
          # Add GitLab remote with token authentication
          if [ -n "${{ secrets.GITLAB_TOKEN }}" ]; then
            GITLAB_URL_WITH_TOKEN=$(echo "$GITLAB_REPO_URL" | sed "s|https://|https://oauth2:${{ secrets.GITLAB_TOKEN }}@|")
            git remote add gitlab "${GITLAB_URL_WITH_TOKEN}" || git remote set-url gitlab "${GITLAB_URL_WITH_TOKEN}"
          else
            git remote add gitlab "${GITLAB_REPO_URL}" || git remote set-url gitlab "${GITLAB_REPO_URL}"
          fi
          
      - name: Push to GitLab
        run: |
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          
          # Fetch from GitLab to check branch state (don't fail if branch doesn't exist)
          git fetch gitlab 2>&1 || echo "Note: Could not fetch from GitLab (branch may not exist yet)"
          
          # Check if remote branch exists
          if git ls-remote --heads gitlab ${CURRENT_BRANCH} | grep -q ${CURRENT_BRANCH}; then
            # Remote branch exists - check if branches have diverged
            git fetch gitlab ${CURRENT_BRANCH}:refs/remotes/gitlab/${CURRENT_BRANCH} 2>&1 || true
            
            # Check if GitLab branch is an ancestor of our branch (can fast-forward)
            if git merge-base --is-ancestor refs/remotes/gitlab/${CURRENT_BRANCH} HEAD 2>/dev/null; then
              # Safe to push - branches are compatible
              echo "Pushing to GitLab (fast-forward compatible)..."
              git push gitlab ${CURRENT_BRANCH}:${CURRENT_BRANCH}
            else
              # Branches have diverged - need to merge GitLab changes first
              echo "Branches have diverged. Merging GitLab changes before push..."
              git merge refs/remotes/gitlab/${CURRENT_BRANCH} --allow-unrelated-histories --no-edit -m "Merge from GitLab [skip sync]" || {
                echo "❌ Merge failed - branches have conflicting changes"
                echo "Please resolve conflicts manually or sync GitLab changes to GitHub first"
                exit 1
              }
              git push gitlab ${CURRENT_BRANCH}:${CURRENT_BRANCH}
            fi
          else
            # Branch doesn't exist on GitLab - safe to push (creates new branch)
            echo "Creating new branch ${CURRENT_BRANCH} on GitLab..."
            git push gitlab ${CURRENT_BRANCH}:${CURRENT_BRANCH}
          fi
          
      - name: Sync status
        run: |
          echo "✅ Successfully synced to GitLab"
          echo "Branch: ${GITHUB_REF#refs/heads/}"
          echo "Commit: ${GITHUB_SHA}"

